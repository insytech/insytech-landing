---
import BtnLink from "../shared/BtnLink.astro";
import Paragraph from "../shared/Paragraph.astro";
---

<form id="contact-form" class="space-y-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
            <label
                for="name"
                class="block font-medium text-gray-800 dark:text-gray-200 mb-2"
            >
                Nombre y Apellido*
            </label>
            <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-800 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-[#005EB8]"
            />
        </div>
        <div>
            <label
                for="company"
                class="block font-medium text-gray-800 dark:text-gray-200 mb-2"
            >
                Compañía*
            </label>
            <input
                type="text"
                id="company"
                name="company"
                required
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-800 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-[#005EB8]"
            />
        </div>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
            <label
                for="email"
                class="block font-medium text-gray-800 dark:text-gray-200 mb-2"
            >
                Email*
            </label>
            <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-800 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-[#005EB8]"
            />
        </div>
        <div>
            <label
                for="phone"
                class="block font-medium text-gray-800 dark:text-gray-200 mb-2"
            >
                Teléfono*
            </label>
            <input
                type="tel"
                id="phone"
                name="phone"
                required
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-800 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-[#005EB8]"
            />
        </div>
    </div>
    <div>
        <label
            for="message"
            class="block font-medium text-gray-800 dark:text-gray-200 mb-2"
        >
            Describe tu operación o desafío técnico.
        </label>
        <textarea
            id="message"
            name="message"
            rows="4"
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-800 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-[#005EB8]"
        ></textarea>
    </div>
    <div class="text-center" data-contact-submit>
        <button
            type="submit"
            class="w-full px-6 py-4 bg-[#005EB8] text-white font-bold rounded-xl hover:bg-[#004a92] transition-colors flex items-center justify-center gap-2"
        >
            Enviar Información
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><path d="m22 2-7 20-4-9-9-4Z"></path><path d="M22 2 11 13"
                ></path></svg
            >
        </button>
    </div>
    <p
        id="contact-status"
        class="text-center text-sm mt-2 text-gray-600 dark:text-gray-400 hidden"
    >
    </p>
    <Paragraph
        className="text-center text-sm mt-4 text-gray-600 dark:text-gray-400"
    >
        Al enviar este formulario, aceptas nuestro{" "}
        <a
            href="/Privacy"
            target="_blank"
            rel="noopener noreferrer"
            class="text-[#005EB8] dark:text-[#00B5E2] font-medium underline"
        >
            aviso de privacidad
        </a>
        .
    </Paragraph>
</form>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("contact-form");
        if (!form) return;
        const statusEl = document.getElementById("contact-status");

        async function submitForm(e: { preventDefault: () => void }) {
            e.preventDefault();
            const fd = new FormData(form as HTMLFormElement);
            const name = (fd.get("name") || "").toString().trim();
            const email = (fd.get("email") || "").toString().trim();
            const payload = {
                name,
                company: (fd.get("company") || "").toString().trim(),
                email,
                phone: (fd.get("phone") || "").toString().trim(),
                message: (fd.get("message") || "").toString().trim(),
            };

            if (!name && !email) {
                if (statusEl) {
                    statusEl.textContent = "Ingrese al menos Nombre o Email.";
                    statusEl.classList.remove("hidden");
                }
                return;
            }

            const submitBtn = (form as HTMLFormElement).querySelector(
                'button[type="submit"]',
            );
            const originalText = submitBtn ? submitBtn.textContent : "";
            if (submitBtn) {
                (submitBtn as HTMLButtonElement).disabled = true;
                (submitBtn as HTMLButtonElement).innerHTML =
                    `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Enviando...`;
            }
            if (statusEl) {
                statusEl.classList.add("hidden");
                statusEl.textContent = "";
            }

            try {
                const res = await fetch("/api/sendToPipedrive", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                if (!res.ok) throw new Error(`Error ${res.status}`);

                if (statusEl) {
                    statusEl.textContent =
                        "¡Gracias! Hemos recibido su información.";
                    statusEl.classList.remove("hidden");
                    statusEl.classList.add(
                        "text-green-600",
                        "dark:text-green-400",
                    );
                }
                (form as HTMLFormElement).reset();
            } catch (err) {
                if (statusEl) {
                    statusEl.textContent =
                        "No se pudo enviar. Intenta más tarde.";
                    statusEl.classList.remove("hidden");
                    statusEl.classList.add("text-red-600", "dark:text-red-400");
                }
                console.error(err);
            } finally {
                if (submitBtn) {
                    (submitBtn as HTMLButtonElement).disabled = false;
                    (submitBtn as HTMLButtonElement).textContent =
                        originalText || "Enviar Información";
                }
            }
        }

        form.addEventListener("submit", submitForm);
    });
</script>

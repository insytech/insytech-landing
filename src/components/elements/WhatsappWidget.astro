---
export interface Props {
    phone?: string;
    contactName?: string;
    department?: string;
    company?: string;
    presetMessage?: string;
    tooltipText?: string;
}

const contactName = Astro.props.contactName ?? "Ventas";
const department = Astro.props.department ?? "Ventas";
const company = Astro.props.company ?? "Insytech";
const presetMessage =
    Astro.props.presetMessage ??
    `Hola, me gustaría más información sobre sus soluciones en ${company}.`;
const tooltipText =
    Astro.props.tooltipText ?? "¿Necesitas ayuda?\nChatea con nosotros";
---

<!-- Botón flotante + tooltip -->
<div class="fixed bottom-6 right-6 z-[55]">
    <div class="flex items-center gap-3">
        <div
            class="hidden sm:block text-sm leading-tight bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 shadow-md rounded-md px-3 py-2 text-gray-800 dark:text-gray-200"
        >
            {tooltipText.split("\n").map((l) => <div>{l}</div>)}
        </div>

        <button
            type="button"
            aria-label="Abrir chat de WhatsApp"
            data-wa-toggle
            class="w-14 h-14 rounded-full bg-[#25D366] hover:brightness-105 shadow-xl grid place-items-center"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 448 512"
                class="w-7 h-7 text-white fill-current"
            >
                <path
                    d="M380.9 97.1C339 55.1 283.2 32 224.8 32 106.5 32 9.1 129.4 9.1 247.7c0 38.2 9.9 75.5 28.8 108.3L0 480l126.5-33c31.9 17.5 67.9 26.7 104.8 26.7h.1c118.2 0 215.6-97.4 215.6-215.7 0-58.4-23.1-114.2-65.1-156.9zM224.9 438.7h-.1c-33.2 0-65.7-8.9-94-25.7l-6.7-4-75.1 19.6 20.1-73.2-4.3-7c-17.9-29.1-27.3-62.7-27.3-97 0-103.1 83.9-187 187.1-187 50 0 96.9 19.5 132.3 55 35.3 35.4 54.7 82.4 54.7 132.4 0 103.2-84 187.1-187.6 187.1zm101.3-138.5c-5.5-2.7-32.6-16.1-37.7-17.9-5.1-1.9-8.8-2.7-12.5 2.7-3.7 5.5-14.3 17.9-17.6 21.6-3.3 3.7-6.5 4.1-12 1.4-5.5-2.7-23.2-8.5-44.2-27.2-16.3-14.5-27.3-32.4-30.5-37.9-3.2-5.5-.3-8.5 2.4-11.2 2.5-2.5 5.5-6.5 8.2-9.8 2.7-3.3 3.7-5.5 5.5-9.3 1.8-3.7.9-7-0.4-9.7-1.4-2.7-12.5-30.1-17.1-41.3-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-7-.2-10.8-.2s-9.9 1.4-15.1 7c-5.1 5.5-19.9 19.4-19.9 47.4 0 27.9 20.4 54.9 23.2 58.6 2.7 3.7 40.1 61.3 97.2 86 13.6 5.9 24.2 9.4 32.5 12.1 13.7 4.3 26.3 3.7 36.2 2.2 11-1.6 32.6-13.3 37.2-26.1 4.6-12.8 4.6-23.8 3.2-26.1-1.3-2.3-5.1-3.7-10.6-6.4z"
                ></path>
            </svg>
        </button>
    </div>
</div>

<!-- Panel emergente -->
<div
    data-wa-panel
    class="hidden fixed bottom-24 right-6 w-[320px] max-w-[90vw] z-[60]"
>
    <div
        class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 shadow-2xl rounded-2xl overflow-hidden"
    >
        <div class="relative bg-[#25D366] text-white px-4 py-3">
            <div class="font-semibold">Comenzar una conversación</div>
            <div class="text-sm opacity-90">
                ¡Hola! Haz clic en uno de nuestros miembros de abajo para
                chatear por WhatsApp
            </div>

            <!-- botón cerrar en el header -->
            <button
                type="button"
                data-wa-close
                aria-label="Cerrar"
                class="absolute right-2 top-2 w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 text-white grid place-items-center"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path
                        fill-rule="evenodd"
                        d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 11-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z"
                        clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>

        <div class="p-3 text-xs text-gray-600 dark:text-gray-300">
            El equipo suele responder en unos minutos.
        </div>

        <!-- Tarjeta de contacto -->
        <button
            type="button"
            data-wa-open
            class="w-full text-left px-3 py-3 hover:bg-gray-50 dark:hover:bg-gray-800 transition"
        >
            <div class="flex items-center gap-3">
                <div
                    class="w-12 h-12 rounded-full bg-[#25D366]/10 text-[#25D366] grid place-items-center"
                >
                    <!-- ícono grande -->
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 448 512"
                        class="w-6 h-6 fill-current"
                        ><path
                            d="M380.9 97.1C339 55.1 283.2 32 224.8 32 106.5 32 9.1 129.4 9.1 247.7c0 38.2 9.9 75.5 28.8 108.3L0 480l126.5-33c31.9 17.5 67.9 26.7 104.8 26.7h.1c118.2 0 215.6-97.4 215.6-215.7 0-58.4-23.1-114.2-65.1-156.9z"
                        ></path></svg
                    >
                </div>
                <div class="flex-1">
                    <div class="font-semibold text-gray-900 dark:text-gray-100">
                        {contactName}
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        {department}
                    </div>
                </div>
                <div class="text-[#25D366]">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10.293 15.707a1 1 0 010-1.414L13.586 11H4a1 1 0 110-2h9.586l-3.293-3.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </button>
    </div>

    <!-- eliminado: botón cerrar flotante inferior que se superponía al launcher -->
</div>

<script>
    // Utilidades: construir URL y abrir chat
    const WA_PHONE = "528128927509";
    const WA_TEXT = "Hola, me interesa una solución de automatización.";

    function buildWhatsAppUrl(phone: any, text: string | number | boolean) {
        const msg = typeof text === "string" ? encodeURIComponent(text) : "";
        const num = String(phone).replace(/\D/g, "");
        return `https://api.whatsapp.com/send?phone=${num}&text=${msg}`;
    }

    function openWhatsApp(phone: string, text: string) {
        const url = buildWhatsAppUrl(phone, text);
        const w = window.open(url, "_blank", "noopener");
    }

    // Control del panel
    function togglePanel(show: boolean) {
        const panel = document.querySelector("[data-wa-panel]");
        if (!panel) return;
        if (show) panel.classList.remove("hidden");
        else panel.classList.add("hidden");
    }

    document.addEventListener("DOMContentLoaded", () => {
        const btn = document.querySelector("[data-wa-toggle]");
        const panel = document.querySelector("[data-wa-panel]");
        const close = document.querySelector("[data-wa-close]");
        const openers = panel?.querySelectorAll("[data-wa-open]") ?? [];

        // Mostrar panel y ocultar launcher para evitar superposición visual
        btn?.addEventListener("click", () => {
            togglePanel(true);
            btn?.classList.add("hidden");
        });

        // Cerrar panel y mostrar launcher
        const closePanel = () => {
            togglePanel(false);
            btn?.classList.remove("hidden");
        };

        close?.addEventListener("click", closePanel);

        openers.forEach((el) =>
            el.addEventListener("click", () => {
                openWhatsApp(WA_PHONE, WA_TEXT);
                closePanel();
            }),
        );

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closePanel();
        });
    });
</script>
